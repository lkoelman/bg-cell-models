/**
 * Hoc Prototype for Miocinovic STN template for use with any SWC morphology.
 *
 * Channel density distributions (peak conductances) are determined based
 * on the arc distance from the soma along the neurites.
 *
 * @author      Lucas Koelman
 * @date        01/04/2018
 */

// load_file("stdlib.hoc")
// load_file("stdrun.hoc")

/**
 * Properly encapsulated version of STN cell that doesn't pollute global
 * namespace.
 *
 * Example
 * -------
 * 
 * >>> from neuron import h
 * >>> h.load_file('stdrun.hoc')
 * >>> h.load_file('import3d.hoc')
 * >>> 
 * >>> icell = h.STN_morph_arcdist()
 * >>> imorphology = h.Import3d_SWC_read()
 * >>> imorphology.input(str("/path/to/morphology.swc"))
 * >>> importer = h.Import3d_GUI(imorphology, 0)
 * >>> importer.instantiate(icell)
 * >>> icell.del_unused_sections()
 * >>> icell.insert_biophys()
 * >>> set_discretization_nseg(icell.all, f_lambda=100.0)
 * >>> icell.set_biophys_spatial()
 *
 * To simplify this process, you can also use this template with
 * the BluePyOpt class 'NrnFileMorphology' defined in
 * https://github.com/BlueBrain/BluePyOpt/blob/master/bluepyopt/ephys/morphologies.py
 */
begintemplate STN_morph_arcdist

    // Hoc template starts new namespace that is encapsulated/isolated
    // - Declare public members using 'public <varname>'
    // - Cannot initialize variables outside funcitons, except 'create <secname>'
    // - objref are public by default

    // Import3d requires following pairs of section array and SectionList:
    // (soma, somatic), (dend, basal), (apic, apical), (axon, axonal), (,all)
    // The following variables are not required but can be inluded:
    // (myelin, myelinated), (node, nodal)

    // Section variables
    public soma

    // Section array variables required by Import3d
    create soma[1], dend[1], apic[1], axon[1] //, myelin[1], node[1]

    // Section list variables required by Import3d
    objref all, somatic, basal, apical, axonal //, myelinated, nodal

    // 'this' is reserved keyword but must be declared if used
    objref this

    // Other public variables
    public v_init, cai0, cao0, nai0, nao0, ki0, ko0, with_extracellular
    objref fih_ions, fih_states // FInitializeHandlers for ions

    // =========================================================================
    // Public initialization functions
    // =========================================================================

    /**
     * Cell constructor.
     */
    proc init() {

        // Initialize sectionlists rquired by Morphology Importer & BluePyOpt interface
        all = new SectionList()
        somatic = new SectionList()
        basal = new SectionList()
        apical = new SectionList()
        axonal = new SectionList()
        // myelinated = new SectionList()
        // nodal = new SectionList()

        set_constant_params()
        with_extracellular = 1

        fih_ions = new FInitializeHandler(1, "init_ions()", this)
        fih_states = new FInitializeHandler(1, "init_states()", this)
    }


    /**
     * Set biophysical properties of sections.
     *
     * NOTE: conductances assigned here will be copied to additonally created
    *        sections.
     *
     * @pre     Morphology must be instantiated (all sections and their spatial
     *          coordinates must be final).
     *
     * @post    All mechanisms are inserted but spatially non-uniform,
     *          segment-wise properties are not yet final.
     */
    proc insert_biophys() {

        forsec somatic {
            Ra = 150.2  //Ohm-cm//  //from Gillies 2005
            cm = 1
  
            insert Cacum    
                cai0_Cacum = cai0_ca_ion
            insert CaT
                gcaT_CaT = my_gcaT_CaT
            insert HVA
                gcaL_HVA = my_gcaL_HVA
                gcaN_HVA = my_gcaN_HVA
            insert sKCa 
                gk_sKCa = my_gk_sKCa
            insert KDR  
                gk_KDR = my_gk_KDR
            insert Kv31
                gk_Kv31 = my_gk_Kv31
            insert Na   
                gna_Na = my_gna_Na
            insert NaL
                gna_NaL = my_gna_NaL    
            insert Ih
                gk_Ih = my_gk_Ih
            insert STh  
                gpas_STh = my_gpas_STh          
        
            if (with_extracellular) {
                insert extracellular xraxial=1e+09 xg=1e+09 xc=0
            }
        }

        forsec basal {
            Ra = 150.2  //Ohm-cm//  //from Gillies 2005
            cm = 1

            // conductances for dendrites set at the end of file    
            insert Cacum    
                cai0_Cacum = cai0_ca_ion
            insert CaT
            insert HVA
            insert sKCa //CHANGED AT THE END 1.8*
            insert KDR  
            insert Kv31
            insert Na   
                gna_Na = 0.65*1e-7
            insert NaL
                gna_NaL = 0.65*8.1e-6
            insert Ih
            insert STh  
                gpas_STh = my_gpas_STh          

            if (with_extracellular) {
                insert extracellular xraxial=1e+09 xg=1e+09 xc=0
            }
        }

        // TODO: Should only be applied to Axon initial segment
        forsec axonal {
            Ra = 150.2  //Ohm-cm//  //from Gillies 2005
            cm = 1
    
            insert Cacum    
                cai0_Cacum = cai0_ca_ion
            insert CaT
                gcaT_CaT = my_gcaT_CaT
            insert HVA
                gcaL_HVA = my_gcaL_HVA
                gcaN_HVA = my_gcaN_HVA
            insert sKCa 
                gk_sKCa = my_gk_sKCa
            insert KDR  
                gk_KDR = my_gk_KDR
            insert Kv31
                gk_Kv31 = my_gk_Kv31
            insert Na   
                gna_Na = my_gna_Na
            insert NaL
                gna_NaL = my_gna_NaL    
            insert Ih
                gk_Ih = my_gk_Ih
            insert STh  
                gpas_STh = my_gpas_STh          

            if (with_extracellular) {
                insert extracellular xraxial=1e+09 xg=1e+09 xc=0
            }

        }

        // Ion styles from Gillies & Willshaw model
        // NOTE: original cinit was 1, can set to 0 to set on per-cell basis
        forsec all {
            ion_style("na_ion",1,2,1,0,1)
            ion_style("k_ion",1,2,1,0,1)
            ion_style("ca_ion",3,2,1,1,1)
        }

        // If CVode is used
        // cvode.atol(0.0001)
        // cvode.atolscale(soma[0].cai, 1.0e-3)
    }


    func calc_density() { \
        local b, c, prox, dist
        // a = $1 // A: density at the soma
        b = $1 // B: overall density to be distributed across the dendritic trees.
        c = $2 // C: proportion of the density that is uniformly distributed across the trees
        prox = $3 // D: proximity, how the reamining density is distributed
        dist = $4 // Normalized distance (between 0-1)
        
        if (prox == 0) { 
            f = 1   
        } else {
            if (prox > 0) { 
                f = (1 - prox - dist) / (1 - prox)
            } else { 
                f = (prox + dist) / (1 + prox) 
            }
        } 
        if (f < 0) {
            f = 0
        }

        // Shouldn't it be c + f (b - c) ? Since c is the uniform part, and b is the total
        return c + (f * b)
    }


    /**
     * Set spatially varying (non-uniform) biophysical properties.
     *
     * NOTE: as in the original implementation, each section has uniform
     *       channel density (conductance).
     *
     * @pre     Must be called _after_ nseg (number of segments per section)
     *          are set to their final value. Otherwise distributions will be invalid.
     *
     * @post    All spatially non-uniform, segment-wise properties are finalized.
     */
    proc set_biophys_spatial() { \
        localobj leaf_secs, secref

        // Make soma(0.0) origin for distance measurement
        soma[1] {
            distance(0, 0)
        }

        // Maximum dendrite-soma distance
        max_dist = 0.0 // constant 734.15 in Miocinovic model
        leaf_secs = new SectionList()
        forsec basal {
            secref = new SectionRef()
            if (secref.nchild() < 1) {
                leaf_secs.append()
            }
        }
        forsec leaf_secs {
            leaf_dist = distance(1)
            if (leaf_dist > max_dist) {
                max_dist = leaf_dist
            }
        }
        print "maximum dendrite length in ", this, " is ", max_dist

        // A,B,C,D parameters from Gillies 2005, Fig. 2. Values in Table A1)
        kdr_B = 9.32e-5
        kdr_C = 4.22e-5
        kdr_D = -0.05

        kfr_B = 1.0e-3
        kfr_C = 8.91e-4
        kfr_D = 0.8
        
        kca_B = 3.92e-5 * 1.8 // factor 1.8 added by Miocinovic
        kca_C = 0
        kca_D = -0.52
        
        hcn_B = 5.1e-4
        hcn_C = 0
        hcn_D = -0.39
        
        cat_B = 1.67e-3
        cat_C = 1.17e-3
        cat_D = -0.01
        
        can_B = 4.79e-4
        can_C = 0
        can_D = 0.5
        
        cal_B = 1.87e-3
        cal_C = 1.21e-4
        cal_D = -0.57

        forsec basal {

            // Original model only has one segment per section.
            // Here we must set conductance in each segment.
            for (x, 0) {

                // Arc distance from middle 3D point to soma
                arc_dist = distance(x)
                norm_dist = arc_dist / max_dist   

                //set up conductances
                gk_KDR(x) = calc_density(kdr_B, kdr_C, kdr_D, norm_dist)

                gcaT_CaT(x) = calc_density(cat_B, cat_C, cat_D, norm_dist)
                gcaL_HVA(x) = calc_density(cal_B, cal_C, cal_D, norm_dist)
                gcaN_HVA(x) = calc_density(can_B, can_C, can_D, norm_dist)

                gk_sKCa(x) = calc_density(kca_B, kca_C, kca_D, norm_dist)
                gk_Kv31(x) = calc_density(kfr_B, kfr_C, kfr_D, norm_dist)
                gk_Ih(x) = calc_density(hcn_B, hcn_C, hcn_D, norm_dist)
            }
        }
    }


    /**
     * Return terminal section of axon
     */
//    obfunc axon_terminal_ref() { \
//        localobj leaf_secs, secref
//        leaf_secs = new SectionList()
//        forsec axonal {
//            secref = new SectionRef()
//            if (secref.nchild() < 1) {
//                return secref
//            }
//        }
//        return nil
//    }

    // =========================================================================
    // Initializers for Hoc FInitializeHandler
    // =========================================================================

    /**
     * Set initial ion concentrations
     */
    proc init_ions() {
        // NOTE: last param of ion_style() call (cinit) is 1, so each
        // segment's ion<i>/ion<0> variables are set from the global
        // variables ion<i/o>0_<ion>_ion. Alternative is to set cinit to 0
        // and here do a double loop forsec, for (x, 0), ion<i/0>(x) = val/
        forsec somatic {
            cai0_Cacum = this.cai0
            cai0_ca_ion = this.cai0
            cao0_ca_ion = this.cao0
            ki0_k_ion = this.ki0
            ko0_k_ion = this.ko0 
            nao0_na_ion = this.nao0
            nai0_na_ion = this.nai0
        }
        forsec basal {
            cai0_Cacum = this.cai0
            cai0_ca_ion = this.cai0
            cao0_ca_ion = this.cao0
            ki0_k_ion = this.ki0
            ko0_k_ion = this.ko0  
            nao0_na_ion = this.nao0
            nai0_na_ion = this.nai0
        }
    }

    /**
     * Initialize state variables
     */
    proc init_states() {
        forsec all {
            v = this.v_init
        }
    }

    // =========================================================================
    // Private initialization functions
    // =========================================================================


    /**
     * Set variables in class/prototype namespace.
     */
    proc set_constant_params() {
        v_init = -60

        // Extracell. ion concentrations taken from Bevan,Wilson 1999 paper (slice bathing solution)                                 
        // Intracell. ion concentrations are typical mammalian values (from Johnston & Wu, 1999 via NEURON tutorial)
        cai0 = 1e-4  //from Gillies mod file  //was 2e-4     
        cao0 = 2             
        ki0 = 140 
        ko0 = 2.5     
        nao0 = 126   
        nai0 = 10 
        
        // Densities at the soma (parameter 'A' in Gillies 2006 Table A1)
        //insert CaT
        my_gcaT_CaT = 0 //0.001 (mho/cm2)
        //insert HVA
        my_gcaL_HVA = 9.5e-4 //0.002 (mho/cm2)
        my_gcaN_HVA = 1.15e-3 //0.012 (mho/cm2)
        //insert sKCa   
        my_gk_sKCa = 1.8*6.84e-5 //0.0001 (mho/cm2)
        //insert KDR    
        my_gk_KDR = 3.84e-3 //3.842910637e-03 (mho/cm2)
        //insert Kv31
        my_gk_Kv31 = 1.2*1.34e-2 //0.015 (mho/cm2)
        //insert Na 
        my_gna_Na = 0.75*1.48e-2 //1.0e-7 (mho/cm2)
        //insert NaL
        my_gna_NaL = 0.75*1.11e-5 //0.81e-5 (mho/cm2)   
        //insert Ih
        my_gk_Ih = 1.01e-3 //0.001 (mho/cm2)    
        //insert STh    
        my_gpas_STh = 7.84112e-05 //7.84112e-05 (mho/cm2) <0,1e9>
    }


    /**
     * Delete unused sections created by template before loading morphology.
     */
    proc del_unused_sections() { \
        local ncell

        ncell = 0
        forsec apical {
            ncell = ncell + 1
        }
        if (!ncell) {
            apic[0] delete_section()
        }

        ncell = 0
        forsec axonal {
            ncell = ncell + 1
        }
        if (!ncell) {
            axon[0] delete_section()
        }
    }

endtemplate STN_morph_arcdist